{
  "version": "1.0",
  "projectName": "epic6-slack-conversational",
  "description": "Epic 6: Conversational Slack Support Bot â€” @mention handling, status queries, draft refinement, quick actions, customer context, thread state",
  "stories": [
    {
      "id": "story-ml6uuzdq",
      "title": "Epic 6.1: @Mention Handling + Intent Router (#156)",
      "description": "Implement @mention handling for the support bot in Slack. When team members @mention the bot, parse their intent and route to the appropriate handler.\n\n## Files to Create\n```\npackages/slack/src/handlers/mention.ts      # @mention event handler\npackages/slack/src/intents/router.ts        # Intent classification + routing\npackages/slack/src/intents/types.ts         # Intent type definitions\npackages/slack/src/handlers/__tests__/mention.test.ts\npackages/slack/src/intents/__tests__/router.test.ts\n```\n\n## Implementation\n\n### 1. Intent Types (types.ts)\n```typescript\ntype IntentCategory = \n  | \"status_query\"    // \"anything urgent?\", \"whats pending?\"\n  | \"draft_action\"    // \"approve\", \"send\", \"simplify\"\n  | \"context_lookup\"  // \"history with X\", \"who is X\"\n  | \"escalation\"      // \"escalate to [name]\"\n  | \"unknown\"         // fallback\n\ninterface ParsedIntent {\n  category: IntentCategory\n  confidence: number\n  entities: Record<string, string> // email, name, etc.\n  rawText: string\n}\n```\n\n### 2. Mention Handler (mention.ts)\n- Subscribe to Slack `app_mention` event\n- Parse text after @mention\n- Route to intent router\n- Post response in thread (not channel)\n\n### 3. Intent Router (router.ts)\n- Pattern matching for intent categories\n- Entity extraction (emails, names)\n- Unknown intent fallback with help message\n\n### 4. Help Response\n```\nI can help with:\n- Status queries: \"anything urgent?\", \"whats pending?\", \"status\"\n- Draft refinement: reply to my draft notifications with feedback\n- Quick actions: \"approve and send\", \"escalate to [name]\", \"archive\"\n- Customer lookup: \"history with customer@email.com\"\n\nJust @mention me with what you need!\n```\n\n## TDD Tests to Write FIRST\n1. Basic @mention detection and response\n2. Intent parsing for each category\n3. Unknown intent fallback response\n4. Threading behavior (response in thread, not channel)\n5. Entity extraction (emails, names)\n6. Edge cases: empty mention, mention with only whitespace\n\n## Axiom Logging\nLog every intent detection: `traceId`, `slackThreadTs`, `userId`, `rawText`, `detectedIntent`, `confidence`",
      "priority": 1,
      "passes": true,
      "validationCommand": "cd ~/Code/skillrecordings/support && bun run check-types && bun test packages/slack/src/handlers/__tests__/mention.test.ts packages/slack/src/intents/__tests__/router.test.ts 2>&1 | tail -30",
      "acceptanceCriteria": [
        "Bot responds to @supportbot mentions in configured channel(s)",
        "Mentions parsed for intent categories: query, action, feedback, unknown",
        "Unknown intents get helpful help response listing capabilities",
        "Response posted in thread (not polluting main channel)",
        "Intent detection logged to Axiom",
        "Tests written FIRST (TDD)"
      ]
    },
    {
      "id": "story-ml6uw31d",
      "title": "Epic 6.2: Status Queries (#157)",
      "description": "Implement status query handlers so team members can ask the bot about support queue health directly in Slack.\n\n## Files to Create\n```\npackages/slack/src/intents/status.ts        # Status query handlers\npackages/slack/src/intents/__tests__/status.test.ts\npackages/slack/src/formatters/status.ts     # Slack Block Kit formatting\n```\n\n## Implementation\n\n### 1. Query Types\n```typescript\ninterface StatusQuery {\n  type: \"urgent\" | \"pending\" | \"health\"\n  filters?: {\n    product?: string\n    assignee?: string\n    since?: Date\n  }\n}\n```\n\n### 2. Handlers\n- `handleUrgentQuery()` â€” list unhandled urgent/high-priority items\n- `handlePendingQuery()` â€” summary by category/product\n- `handleHealthQuery()` â€” quick stats (handled today, pending, avg response time)\n\n### 3. Front API Integration\n- Query conversations with status=open, priority filters\n- Use existing Front SDK (`packages/front-sdk/`)\n- Cache results briefly (30s) to avoid hammering API\n\n### 4. Response Format (Slack Block Kit)\n```\nðŸ“Š *Support Status*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nðŸ”´ *Urgent (3)*\nâ€¢ [TT] License transfer request â€” 2h ago [View](front-link)\nâ€¢ [ER] Refund request urgent â€” 45m ago [View](front-link)\n\nðŸ“‹ *Summary*\nâ€¢ Handled today: 12\nâ€¢ Pending: 8\nâ€¢ Avg response: 1.2h\n```\n\n## TDD Tests to Write FIRST\n1. \"urgent\" query with results\n2. \"urgent\" query empty state\n3. \"pending\" query with category breakdown\n4. \"status\" / \"health\" query with stats\n5. Front link generation\n6. Cache behavior\n\n## Depends On\nStory 1 (6.1) must pass first â€” provides intent routing.",
      "priority": 2,
      "passes": true,
      "validationCommand": "cd ~/Code/skillrecordings/support && bun run check-types && bun test packages/slack/src/intents/__tests__/status.test.ts 2>&1 | tail -30",
      "acceptanceCriteria": [
        "@supportbot anything urgent? lists unhandled urgent items",
        "@supportbot whats pending? shows summary by category",
        "@supportbot status shows health metrics",
        "Results include Front links",
        "Empty states handled gracefully",
        "All queries logged to Axiom"
      ]
    },
    {
      "id": "story-ml6uw334",
      "title": "Epic 6.3: Draft Refinement in Threads (#158)",
      "description": "Enable team members to refine AI-generated drafts by replying to bot notifications in Slack threads. Natural language feedback triggers draft revisions.\n\n## Files to Create\n```\npackages/slack/src/handlers/thread-reply.ts    # Reply handler\npackages/slack/src/intents/draft.ts            # Draft refinement logic\npackages/slack/src/intents/__tests__/draft.test.ts\npackages/slack/src/handlers/__tests__/thread-reply.test.ts\n```\n\n## Implementation\n\n### 1. Refinement Types\n```typescript\ntype RefinementIntent = \n  | { type: \"simplify\" }\n  | { type: \"formalize\" }\n  | { type: \"shorten\" }\n  | { type: \"add_content\"; content: string }\n  | { type: \"mention_topic\"; topic: string }\n  | { type: \"approve\" }\n  | { type: \"reject\"; reason?: string }\n```\n\n### 2. Thread Reply Handler\n- Listen for `message` events in threads where bot has posted\n- Parse refinement intent from reply text\n- Apply refinement to current draft\n- Post revised draft in same thread\n\n### 3. Draft Revision\n- Call LLM to apply refinement (simplify, formalize, etc.)\n- Track version history: original â†’ v1 â†’ v2 â†’ sent\n- Show diff indicator in response\n\n### 4. Approval Flow\n- \"looks good\" / \"approve\" triggers send confirmation\n- Integration point for Epic 4 learning capture\n\n## TDD Tests to Write FIRST\n1. \"simplify\" refinement parses correctly\n2. \"add [link]\" extracts content\n3. Thread reply triggers handler\n4. Draft versioning tracks history\n5. Approval detection\n6. Non-refinement replies ignored gracefully\n\n## Depends On\nStory 1 (6.1) for intent handling",
      "priority": 3,
      "passes": true,
      "validationCommand": "cd ~/Code/skillrecordings/support && bun run check-types && bun test packages/slack/src/intents/__tests__/draft.test.ts packages/slack/src/handlers/__tests__/thread-reply.test.ts 2>&1 | tail -30",
      "acceptanceCriteria": [
        "Reply to draft notification with feedback revises draft",
        "Supports simplify, formalize, shorten, add content refinements",
        "Revised draft posted in same thread",
        "looks good / approve triggers send confirmation",
        "Refinement history tracked for learning",
        "All refinements logged to Axiom"
      ]
    },
    {
      "id": "story-ml6uw337",
      "title": "Epic 6.4: Quick Actions (#159)",
      "description": "Implement quick action commands that let team members take immediate action on support items directly from Slack.\n\n## Files to Create\n```\npackages/slack/src/intents/action.ts           # Quick action handlers\npackages/slack/src/intents/__tests__/action.test.ts\npackages/slack/src/confirmations/action.ts     # Confirmation dialogs\n```\n\n## Implementation\n\n### 1. Action Types\n```typescript\ntype QuickAction = \n  | { type: \"approve_send\" }\n  | { type: \"escalate\"; assignee: string }\n  | { type: \"add_context\"; note: string }\n  | { type: \"archive\" }\n  | { type: \"close\" }\n```\n\n### 2. Action Handlers\n- `handleApproveSend()` â€” send draft via Front API, archive conversation\n- `handleEscalate()` â€” reassign in Front, notify person in Slack\n- `handleAddContext()` â€” add internal note to Front\n- `handleArchive()` â€” archive without sending\n\n### 3. Confirmation Flow\n```\nUser: \"approve and send\"\nBot: \"Ready to send this response to customer@email.com:\n     > [draft preview, first 200 chars...]\n     Reply yes to confirm or cancel to abort\"\nUser: \"yes\"\nBot: \"âœ… Response sent! Conversation archived.\"\n```\n\n### 4. Error Handling\n- Graceful failure if Front API errors\n- Rollback messaging if partial failure\n\n## TDD Tests to Write FIRST\n1. \"approve and send\" parses correctly\n2. \"escalate to [name]\" extracts assignee\n3. Confirmation flow state machine\n4. Front API error handling\n5. Action logging to Axiom\n\n## Depends On\nStories 1, 3 for intent handling and thread context",
      "priority": 4,
      "passes": true,
      "validationCommand": "cd ~/Code/skillrecordings/support && bun run check-types && bun test packages/slack/src/intents/__tests__/action.test.ts 2>&1 | tail -30",
      "acceptanceCriteria": [
        "approve and send sends draft and archives",
        "escalate to [name] reassigns in Front and notifies",
        "needs more context adds internal note",
        "archive/close archives without sending",
        "Confirmation step before destructive actions",
        "All actions logged to Axiom"
      ]
    },
    {
      "id": "story-ml6uw33e",
      "title": "Epic 6.5: Customer Context Lookup (#160)",
      "description": "Enable team members to query customer history and context directly in Slack.\n\n## Files to Create\n```\npackages/slack/src/intents/context.ts          # Customer lookup handlers\npackages/slack/src/intents/__tests__/context.test.ts\npackages/slack/src/formatters/customer.ts      # Slack formatting for customer data\n```\n\n## Implementation\n\n### 1. Query Types\n```typescript\ninterface CustomerQuery {\n  type: \"history\" | \"profile\" | \"purchases\"\n  email: string\n}\n\ninterface CustomerProfile {\n  email: string\n  name?: string\n  products: string[]\n  lifetimeValue: number\n  supportStats: {\n    totalTickets: number\n    resolvedTickets: number\n    lastContact?: Date\n  }\n}\n```\n\n### 2. Handlers\n- `handleHistoryQuery()` â€” pull prior conversations from Front\n- `handleProfileQuery()` â€” customer summary with purchases and stats\n- `handlePurchasesQuery()` â€” list products owned\n\n### 3. Data Sources\n- Front API for conversation history\n- Purchase data from SDK integrations\n- Aggregate stats from prior tickets\n\n### 4. Response Format\n```\nðŸ‘¤ *Customer Profile*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\ncustomer@email.com\n\nðŸ“¦ *Products*\nâ€¢ Total TypeScript (purchased Jan 2025)\nâ€¢ Epic React (purchased Mar 2024)\n\nðŸ“Š *Support History*\nâ€¢ Total tickets: 5\nâ€¢ Last contact: 2 weeks ago\nâ€¢ Avg resolution: 1.2 days\n\nRecent tickets:\n1. License transfer â€” Resolved âœ…\n2. Login issue â€” Resolved âœ…\n```\n\n## TDD Tests to Write FIRST\n1. \"history with X@email.com\" parses email\n2. \"who is X\" extracts identifier\n3. Profile assembly from multiple sources\n4. Empty state handling\n5. Formatting for Slack Block Kit\n\n## Depends On\nStory 1 (6.1) for intent routing",
      "priority": 5,
      "passes": true,
      "validationCommand": "cd ~/Code/skillrecordings/support && bun run check-types && bun test packages/slack/src/intents/__tests__/context.test.ts 2>&1 | tail -30",
      "acceptanceCriteria": [
        "history with X@email.com pulls prior conversations",
        "who is X@email.com shows customer profile",
        "Profile includes products owned and support stats",
        "Empty state handled gracefully",
        "Queries logged to Axiom"
      ]
    },
    {
      "id": "story-ml6uw33j",
      "title": "Epic 6.6: Thread State Management + Epic 4 Integration (#161)",
      "description": "Implement persistent thread context so the bot remembers what conversation/draft is being discussed, and integrate with Epic 4 learning system.\n\n## Files to Create\n```\npackages/slack/src/state/thread-context.ts     # Thread state management\npackages/slack/src/state/__tests__/thread-context.test.ts\npackages/slack/src/learning/corrections.ts     # Epic 4 integration\npackages/slack/src/learning/__tests__/corrections.test.ts\n```\n\n## Implementation\n\n### 1. Thread Context Schema\n```typescript\ninterface ThreadContext {\n  threadTs: string           // Slack thread timestamp (unique ID)\n  channelId: string\n  conversationId: string     // Front conversation ID\n  currentDraft: string\n  draftVersion: number\n  customerId?: string\n  createdAt: Date\n  lastActivityAt: Date\n  ttlSeconds: number         // Default 3600 (1 hour)\n}\n```\n\n### 2. State Management\n- Redis-backed storage for thread context\n- TTL-based expiration (1 hour default)\n- `getThreadContext()`, `setThreadContext()`, `clearThreadContext()`\n- Stale thread detection and graceful handoff message\n\n### 3. Epic 4 Learning Integration\n```typescript\ninterface CorrectionEvent {\n  conversationId: string\n  originalDraft: string\n  revisedDraft: string\n  refinementType: string\n  userId: string\n  timestamp: Date\n  threadTs: string\n}\n```\n- Capture all refinements as correction events\n- Store in format queryable for training extraction\n- Integration hook for Epic 4 learning pipeline\n\n### 4. Stale Handling\n- \"This thread has expired. Please start a new conversation.\"\n- \"new topic\" / \"different customer\" explicitly clears context\n\n## TDD Tests to Write FIRST\n1. Thread context CRUD operations\n2. TTL expiration behavior\n3. Stale thread detection\n4. Correction event capture\n5. Context clearing on \"new topic\"\n6. Redis connection error handling\n\n## Depends On\nAll prior Epic 6 stories",
      "priority": 6,
      "passes": true,
      "validationCommand": "cd ~/Code/skillrecordings/support && bun run check-types && bun test packages/slack/src/state/__tests__/thread-context.test.ts packages/slack/src/learning/__tests__/corrections.test.ts 2>&1 | tail -30",
      "acceptanceCriteria": [
        "Each thread maintains conversation context",
        "Context persists for configurable TTL window",
        "Stale threads get clear handoff message",
        "All refinements captured as correction events",
        "Corrections queryable for training extraction",
        "Thread state ops logged to Axiom"
      ]
    }
  ],
  "metadata": {
    "createdAt": "2026-02-03T17:10:51.448Z",
    "totalIterations": 6,
    "lastIteration": "2026-02-03T18:02:34.566Z"
  }
}