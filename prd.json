{
  "version": "1.0",
  "projectName": "cli-rearchitect",
  "description": "Rearchitect @skillrecordings/cli as agent-first compiled binary. Parent epic: skillrecordings/support#172. All work in packages/cli/.",
  "stories": [
    {
      "id": "story-ml863g76",
      "title": "Core Infrastructure Types (Phase 0) — Issue #177",
      "description": "Create the foundational CommandContext, CLIError hierarchy, and signal handling modules with full test coverage.\n\n## Context\n- Parent epic: https://github.com/skillrecordings/support/issues/172\n- Full issue: https://github.com/skillrecordings/support/issues/177\n- Read `packages/cli/PROGRESS.md` if it exists for prior story status\n\n## Files to Create\n- `packages/cli/src/core/context.ts` — CommandContext interface + createContext() factory\n- `packages/cli/src/core/errors.ts` — CLIError base + AuthError(10), NetworkError(11), DatabaseError(12)\n- `packages/cli/src/core/signals.ts` — AbortController wrapper + SIGINT/SIGTERM + cleanup registry\n- `packages/cli/tests/unit/core/context.test.ts`\n- `packages/cli/tests/unit/core/errors.test.ts`\n- `packages/cli/tests/unit/core/signals.test.ts`\n- `packages/cli/PROGRESS.md`\n\n## Key Design\nCommandContext carries: stdin, stdout, stderr, config, signal (AbortSignal), secrets (SecretsProvider), format ('json'|'text'|'table'), onCleanup(fn).\nExit codes: 0=success, 1=error, 2=usage, 10=auth, 11=network, 12=db.\nCLIError has: userMessage, exitCode, suggestion?, debugMessage?.\nSignal handling: trap SIGINT(130)/SIGTERM(143), run cleanup registry in reverse, second SIGINT force-exits.\n\n## TDD: Write failing tests first, then implement. Table-driven tests preferred.\n\n## On Completion\nUpdate packages/cli/PROGRESS.md with completion summary. Commit: `feat(cli): core infrastructure types - context, errors, signals`",
      "priority": 1,
      "passes": true,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "CommandContext interface exported with stdin/stdout/stderr/config/signal/secrets/format/onCleanup",
        "createContext() returns valid context with defaults and accepts partial overrides",
        "CLIError AuthError NetworkError DatabaseError all exported with correct exit codes",
        "formatError() renders user message + suggestion and handles unknown errors",
        "Signal handlers trap SIGINT and SIGTERM",
        "Cleanup registry runs callbacks in reverse order",
        "Second SIGINT force-exits",
        "All new tests pass"
      ]
    },
    {
      "id": "story-ml863q07",
      "title": "db-status Migration PoC (Phase 0) — Issue #178",
      "description": "Migrate the db-status command to use CommandContext as proof-of-concept. Create test helpers.\n\n## Context\n- Parent epic: #172, Issue: #178\n- Depends on: Story 1 (core types must exist)\n- Read packages/cli/PROGRESS.md for prior story status\n\n## Files to Create/Modify\n- `packages/cli/tests/helpers/test-context.ts` — createTestContext() that captures stdout/stderr buffers\n- `packages/cli/tests/integration/commands/db-status.test.ts` — Table-driven integration tests\n- `packages/cli/src/commands/db-status.ts` — MODIFY: accept CommandContext, use ctx.stdout, lazy getDb()\n\n## Task\n1. Create createTestContext() helper: returns CommandContext with captured stdout/stderr, getStdout()/getStderr() accessors, no-op AbortController, mock secrets\n2. Rewrite db-status: receive CommandContext param, replace console.log→ctx.stdout.write(), replace database singleton→lazy getDb(), add error handling with DatabaseError+suggestion, use ctx.signal for timeout\n3. Write table-driven integration tests: success, connection failure, timeout\n\n## TDD: Write failing tests first. Use createTestContext() to capture and assert output.\n\n## On Completion\nUpdate packages/cli/PROGRESS.md. Commit: `feat(cli): migrate db-status to CommandContext pattern`",
      "priority": 2,
      "passes": true,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "db-status uses CommandContext with no direct console.log or database singleton",
        "db-status handles connection failure with DatabaseError and suggestion",
        "createTestContext() helper captures stdout/stderr for assertions",
        "Table-driven integration tests cover success and error paths",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml863y75",
      "title": "SecretsProvider Abstraction (Phase 1) — Issue #179",
      "description": "Create SecretsProvider interface with 1Password SDK and env var implementations.\n\n## Context\n- Parent epic: #172, Issue: #179\n- Depends on: Story 1 (core types)\n- Read packages/cli/PROGRESS.md\n\n## Files to Create\n- `packages/cli/src/core/secrets.ts` — SecretsProvider interface + OnePasswordProvider + EnvProvider + factory\n- `packages/cli/src/core/secret-refs.ts` — Central manifest of all op:// secret references\n- `packages/cli/tests/unit/core/secrets.test.ts`\n\n## Key Design\nSecretsProvider: { resolve(ref): Promise<string>, resolveAll(refs): Promise<Record>, isAvailable(): Promise<boolean>, name: string }\nOnePasswordProvider: uses @1password/sdk with OP_SERVICE_ACCOUNT_TOKEN, caches resolved secrets\nEnvProvider: extracts key from op:// ref, looks up process.env\nFactory: createSecretsProvider() tries 1Password first, falls back to env\n\n## TDD: Mock @1password/sdk in tests. Test: successful resolution, missing secret, provider fallback, batch resolution.\n\n## On Completion\nUpdate packages/cli/PROGRESS.md. Commit: `feat(cli): SecretsProvider abstraction with 1Password SDK`",
      "priority": 3,
      "passes": true,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "SecretsProvider interface exported",
        "OnePasswordProvider resolves secrets via @1password/sdk (mocked in tests)",
        "EnvProvider falls back to process.env",
        "Factory tries 1Password first then env",
        "Secret refs manifest contains all required secrets",
        "Unit tests cover resolution, missing secret, fallback, batch",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml8646k3",
      "title": "Secret Loading Migration (Phase 1) — Issue #180",
      "description": "Remove old secret loading infrastructure. Wire SecretsProvider into createContext(). Update auth commands.\n\n## Context\n- Parent epic: #172, Issue: #180\n- Depends on: Stories 2+3\n\n## Files to Delete\n- packages/cli/src/preload.ts\n- packages/cli/src/lib/env-loader.ts\n- packages/cli/src/lib/crypto.ts\n\n## Files to Modify\n- packages/cli/src/core/context.ts — Wire SecretsProvider into createContext()\n- packages/cli/src/commands/auth/ — Remove keygen/encrypt/decrypt, add login/status/whoami\n- packages/cli/src/index.ts — Remove preload, update command registration\n\n## Files to Create\n- packages/cli/tests/integration/commands/auth.test.ts\n\n## Key Points\n- Commands that dont need secrets (--help, --version) must never trigger resolution\n- auth status: show active provider + available secrets\n- auth login: validate 1Password token\n- auth whoami: show service account info\n- DELETE: auth keygen, auth encrypt, auth decrypt\n\n## On Completion\nUpdate packages/cli/PROGRESS.md. Commit: `feat(cli): migrate to native 1Password secrets`",
      "priority": 4,
      "passes": true,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "preload.ts env-loader.ts crypto.ts deleted",
        "No references to age encryption remain",
        "SecretsProvider wired into createContext()",
        "skill --help works without secrets configured",
        "auth status shows active provider",
        "Old auth commands removed",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml864fd7",
      "title": "OutputFormatter Abstraction (Phase 2) — Issue #181",
      "description": "Create OutputFormatter with JSON/text/table formatters. Add global --format, --verbose, --quiet flags.\n\n## Context\n- Parent epic: #172, Issue: #181\n- Depends on: Story 2\n\n## Files to Create\n- packages/cli/src/core/output.ts — OutputFormatter interface + JsonFormatter + TextFormatter + TableFormatter\n- packages/cli/tests/unit/core/output.test.ts\n\n## Files to Modify\n- packages/cli/src/core/context.ts — Add output: OutputFormatter to CommandContext\n- packages/cli/src/index.ts — Add global flags\n\n## Key Design\nOutputFormatter: { data(value), table(rows, columns), message(text), success(text), warn(text), error(text), progress(label) }\n- data() → stdout (primary output)\n- message/success/warn/error → stderr\n- JsonFormatter: data() = JSON.stringify to stdout\n- TextFormatter: data() = human-readable to stdout\n- TableFormatter: data() = aligned columns to stdout\n- Auto-detect: if !process.stdout.isTTY, default to JSON\n- Global flags: --format json|text|table (persistent), --verbose/-v, --quiet/-q\n\n## On Completion\nUpdate packages/cli/PROGRESS.md. Commit: `feat(cli): OutputFormatter abstraction with dual output`",
      "priority": 5,
      "passes": true,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "OutputFormatter interface exported",
        "JsonFormatter produces valid JSON on stdout",
        "TextFormatter produces human-readable output",
        "Auto-detection: piped output defaults to JSON",
        "--format flag works and inherited by subcommands",
        "--verbose and --quiet work correctly",
        "Unit tests cover all formatters",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml864mze",
      "title": "Command Migration Batch 1 — Front + Inngest (Phase 2) — Issue #182",
      "description": "Migrate Front and Inngest commands to CommandContext + OutputFormatter. Replace all console.log.\n\n## Context\n- Parent epic: #172, Issue: #182\n- Depends on: Story 5\n\n## Files to Modify\n- packages/cli/src/commands/front/*.ts — All front commands\n- packages/cli/src/commands/inngest/*.ts — All inngest commands (now under inngest subcommand)\n\n## Files to Create\n- packages/cli/tests/integration/commands/front.test.ts\n- packages/cli/tests/integration/commands/inngest.test.ts\n\n## Commands to migrate\nFront: message, conversation, tags, inbox, archive, bulk-archive, pull\nInngest: events, runs, run, signal, investigate, stats, failures, search\n\nFor each command:\n1. Accept CommandContext parameter\n2. Replace console.log→ctx.output.data() or ctx.output.message()\n3. Replace console.error→ctx.output.error()\n4. Use CLIError for error handling with suggestions\n5. Write happy-path + error-path test\n\n## On Completion\nUpdate packages/cli/PROGRESS.md. Commit: `feat(cli): migrate front + inngest commands to OutputFormatter`",
      "priority": 6,
      "passes": true,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "Zero console.log in front/ and inngest/ command files",
        "All front commands use CommandContext + OutputFormatter",
        "All inngest commands use CommandContext + OutputFormatter",
        "skill front conversation <id> --format json outputs valid JSON",
        "Integration tests cover happy + error paths",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml864tat",
      "title": "Command Migration Batch 2 — Axiom + Tools + Memory (Phase 2) — Issue #183",
      "description": "Migrate Axiom, Tools, and Memory commands to CommandContext + OutputFormatter.\n\n## Context\n- Parent epic: #172, Issue: #183\n- Depends on: Story 6\n\n## Files to Modify\n- packages/cli/src/commands/axiom/*.ts\n- packages/cli/src/commands/tools/*.ts (list, search, lookup)\n- packages/cli/src/commands/memory/*.ts\n\n## Files to Create\n- packages/cli/tests/integration/commands/axiom.test.ts\n- packages/cli/tests/integration/commands/tools.test.ts\n- packages/cli/tests/integration/commands/memory.test.ts\n\n## Commands\nAxiom: query, agents, errors, conversation, classifications, workflow-steps, approvals, pipeline-trace, step-timings, error-rate, data-flow-check, tag-health, approval-stats, pipeline-health\nTools: list, search, lookup\nMemory: store, find, get, validate, upvote, downvote, delete, stats, stale\n\nSame pattern: accept CommandContext, replace console.log, use CLIError, write tests.\n\n## On Completion\nUpdate packages/cli/PROGRESS.md. Commit: `feat(cli): migrate axiom + tools + memory commands`",
      "priority": 7,
      "passes": true,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "Zero console.log in axiom/ tools/ memory/ command files",
        "All commands use CommandContext + OutputFormatter",
        "--format json outputs valid JSON for all commands",
        "Integration tests cover happy + error paths",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml864ys3",
      "title": "Command Migration Batch 3 — Remaining Commands (Phase 2) — Issue #184",
      "description": "Migrate all remaining commands: eval, pipeline, deploy, FAQ, KB, health, wizard, responses, dataset, init.\n\n## Context\n- Parent epic: #172, Issue: #184\n- Depends on: Story 7\n\n## Files to Modify\n- packages/cli/src/commands/eval/*.ts\n- packages/cli/src/commands/pipeline/*.ts\n- packages/cli/src/commands/deploys/*.ts\n- packages/cli/src/commands/faq/*.ts\n- packages/cli/src/commands/kb/*.ts\n- packages/cli/src/commands/health.ts\n- packages/cli/src/commands/wizard.ts\n- packages/cli/src/commands/responses/*.ts\n- packages/cli/src/commands/dataset/*.ts\n- packages/cli/src/commands/init.ts\n\n## Goal\nZero console.log calls remain in ANY command file across the entire CLI. Every command uses CommandContext + OutputFormatter.\n\n## On Completion\nUpdate packages/cli/PROGRESS.md. Commit: `feat(cli): complete command migration to OutputFormatter`",
      "priority": 8,
      "passes": false,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "Zero console.log in ANY command file",
        "Every command uses CommandContext + OutputFormatter",
        "--format json works for all commands",
        "Integration tests exist for all command groups",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml8657n3",
      "title": "Dead Code Removal + Deduplication (Phase 5) — Issue #185",
      "description": "Delete dead code, deduplicate shared helpers, update docs.\n\n## Context\n- Parent epic: #172, Issue: #185\n- Depends on: Story 8\n\n## Files to Delete\n- packages/cli/src/commands/front-stats.ts (unregistered standalone script)\n- packages/cli/src/commands/front-cache.ts (unregistered, never wired)\n- packages/cli/src/commands/eval-local/compare.ts (hardcoded fake data stub)\n\n## Files to Create\n- packages/cli/src/lib/eval-seed.ts — Shared seed logic (from eval-pipeline version)\n- packages/cli/src/lib/axiom-client.ts — Deduplicated axiom helpers (getAxiomClient, getDataset, parseTimeRange, formatDuration, formatTime)\n\n## Files to Modify\n- packages/cli/src/commands/eval-local/seed.ts — Import from shared eval-seed.ts\n- packages/cli/src/commands/eval-pipeline/seed.ts — Import from shared eval-seed.ts\n- packages/cli/src/commands/axiom/index.ts — Import from shared axiom-client.ts\n- packages/cli/src/commands/axiom/forensic.ts — Import from shared axiom-client.ts\n- packages/cli/package.json — Remove @skillrecordings/sdk\n- CLAUDE.md — Update with accurate command list and new flags\n\n## On Completion\nUpdate packages/cli/PROGRESS.md. Commit: `chore(cli): remove dead code and deduplicate helpers`",
      "priority": 9,
      "passes": false,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "front-stats.ts front-cache.ts deleted",
        "eval-local compare stub deleted",
        "@skillrecordings/sdk removed from dependencies",
        "Eval seed logic in shared src/lib/eval-seed.ts",
        "Axiom helpers in shared src/lib/axiom-client.ts",
        "CLAUDE.md updated",
        "No dead imports or unused exports",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml865gzq",
      "title": "Compiled Binary Build Script (Phase 3) — Issue #186",
      "description": "Create build.ts for bun build --compile targeting 4 platforms. Handle native modules. Version embedding.\n\n## Context\n- Parent epic: #172, Issue: #186\n- Depends on: Story 9\n\n## Files to Create\n- packages/cli/build.ts — Programmatic Bun.build() for 4 targets\n- packages/cli/tests/e2e/binary.test.ts\n\n## Files to Modify\n- packages/cli/package.json — Add build:compile script\n\n## Key Details\n- Targets: bun-linux-x64, bun-linux-arm64, bun-darwin-x64, bun-darwin-arm64\n- CRITICAL: autoloadDotenv: false (never bake secrets)\n- Define BUILD_VERSION (from package.json) and BUILD_COMMIT (git rev-parse --short HEAD)\n- Minify + sourcemap + bytecode\n- Handle native modules: externalize/replace mysql2, duckdb, @mapbox/node-pre-gyp\n- skill --version prints: skill v1.2.3 (abc1234) bun-linux-x64\n- E2E: compile, run --version, run --help, verify no secrets in binary via strings\n\n## On Completion\nUpdate packages/cli/PROGRESS.md. Commit: `feat(cli): compiled binary build with bun build --compile`",
      "priority": 10,
      "passes": false,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "bun run build:compile produces binaries in dist/",
        "--version outputs correct format",
        "--help works without env vars",
        "No secrets baked into binary",
        "E2E tests verify binary behavior",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml865on5",
      "title": "Release Infrastructure (Phase 3) — Issue #187",
      "description": "Create GitHub Actions release workflow and curl install script.\n\n## Context\n- Parent epic: #172, Issue: #187\n- Depends on: Story 10\n\n## Files to Create\n- .github/workflows/cli-release.yml — Build + release on cli-v* tag push\n- packages/cli/install.sh — Platform-detecting install script\n- packages/cli/tests/e2e/install.test.ts\n\n## Details\nGH Actions: trigger on push tags cli-v*, matrix 4 targets, oven-sh/setup-bun@v2, compile + release + upload\nInstall script: detect platform/arch, download from latest GH release, install to ~/.local/bin/skill, chmod +x, verify --version\n\n## On Completion\nUpdate packages/cli/PROGRESS.md. Commit: `feat(cli): release workflow and install script`",
      "priority": 11,
      "passes": false,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "GitHub Actions workflow is valid YAML",
        "Workflow builds all 4 platform targets",
        "Install script detects platform and arch",
        "Install script downloads and installs binary",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml865xas",
      "title": "MCP Server Mode (Phase 4) — Issue #188",
      "description": "Create MCP server entrypoint exposing CLI commands as MCP tools over stdio.\n\n## Context\n- Parent epic: #172, Issue: #188\n- Depends on: Story 5\n\n## Files to Create\n- packages/cli/src/mcp.ts — MCP server entrypoint with StdioServerTransport\n- packages/cli/tests/integration/mcp.test.ts\n\n## Files to Modify\n- packages/cli/src/index.ts — Add --mcp flag\n- packages/cli/package.json — Add @modelcontextprotocol/sdk dep\n\n## Key Details\n- Uses @modelcontextprotocol/sdk with StdioServerTransport\n- Auto-generate tool registrations by walking Commander command tree\n- Tool names: front-conversation, axiom-query, tools-search, etc.\n- Zod schemas from Commander option definitions\n- CRITICAL: No console.log in MCP mode (stdout = protocol channel), all logging via console.error\n- Tool annotations: readOnlyHint for reads, destructiveHint for destructive ops\n- --mcp flag skips Commander parsing, launches MCP server\n- Exits when stdin closes\n\n## On Completion\nUpdate packages/cli/PROGRESS.md. Commit: `feat(cli): MCP server mode for agent integration`",
      "priority": 12,
      "passes": false,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "skill --mcp launches MCP server on stdio",
        "MCP tools match Commander command tree",
        "Tools have Zod input schemas",
        "Tool annotations set correctly",
        "JSON-RPC via stdin returns valid response",
        "No console.log in MCP mode",
        "Integration tests pass",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml8665cd",
      "title": "Test Coverage Gap Fill + CI (Phase 6) — Issue #189",
      "description": "Fill test coverage gaps. Set up coverage reporting and CI thresholds.\n\n## Context\n- Parent epic: #172, Issue: #189\n- Depends on: Stories 8+10\n\n## Files to Create/Modify\n- packages/cli/vitest.config.ts — Add coverage configuration (@vitest/coverage-v8)\n- .github/workflows/cli-test.yml — CI for tests on every PR touching packages/cli/\n- packages/cli/tests/ — Fill gaps\n\n## Details\nCoverage config: @vitest/coverage-v8, thresholds 80% overall + 90% on src/core/, formats text+lcov+json\nCI: runs on PR, steps: install, check-types, test --coverage, fails below threshold\nGap analysis: run coverage, identify untested paths, add missing tests for edge cases (error handling, config precedence, output format)\n\n## On Completion\nUpdate packages/cli/PROGRESS.md with final summary. Commit: `feat(cli): test coverage CI with 80%+ threshold`",
      "priority": 13,
      "passes": false,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "Coverage report generates with bun vitest run --coverage",
        "Overall coverage >= 80% lines",
        "Core module coverage >= 90% lines",
        "CI workflow runs tests on PR",
        "CI fails if coverage drops below threshold",
        "All tests pass"
      ]
    }
  ],
  "metadata": {
    "createdAt": "2026-02-04T15:13:09.231Z",
    "totalIterations": 7,
    "lastIteration": "2026-02-04T17:00:53.427Z"
  }
}