{
  "version": "1.0",
  "projectName": "faq-real-extraction",
  "description": "Extract REAL FAQ Q&A pairs from DuckDB cache using existing LLM topic classifications. CRITICAL: NO LLM SYNTHESIS - this is verbatim text extraction only. All work must be logged to artifacts/faq-extraction-audit.md with process notes.",
  "stories": [
    {
      "id": "story-ml48u37t",
      "title": "Create extraction script scaffold with audit logging",
      "description": "Create `scripts/extract-real-faqs.ts` with:\n1. Audit logger that writes to `artifacts/faq-extraction-audit.md`\n2. Every major step logs: timestamp, action, reasoning\n3. Script skeleton with NO ai/LLM imports\n\n⛔ FORBIDDEN: Do not import from 'ai', '@ai-sdk/*', or any LLM library\n✅ REQUIRED: Use DuckDB, fs, path only\n\nThe audit file format:\n```\n# FAQ Extraction Audit Log\n\n## [timestamp] Step Name\n**Action:** What was done\n**Reasoning:** Why this approach\n**Output:** What was produced\n```",
      "priority": 1,
      "passes": true,
      "validationCommand": "grep -L \"generateText\\|generateObject\\|from 'ai'\\|from \\\"ai\\\"\" scripts/extract-real-faqs.ts && test -f scripts/extract-real-faqs.ts && echo \"PASS\"",
      "acceptanceCriteria": [
        "scripts/extract-real-faqs.ts exists",
        "File does NOT contain: import.*from.*ai, generateText, generateObject",
        "Audit logger function exists and writes to artifacts/faq-extraction-audit.md",
        "Running script creates audit file with header"
      ]
    },
    {
      "id": "story-ml48u8hx",
      "title": "Load classifications and build topic-to-conversations map",
      "description": "Add function to load `artifacts/phase-1/llm-topics/classifications.json` and create a Map<topicId, conversationId[]>.\n\nLog to audit:\n- Number of topics found\n- Total conversations loaded\n- Top 5 topics by count\n\n⛔ FORBIDDEN: No LLM calls, no content generation\n✅ REQUIRED: Pure file reading and data structure building",
      "priority": 2,
      "passes": true,
      "validationCommand": "grep -q \"loadClassifications\" scripts/extract-real-faqs.ts && grep -L \"generateText\\|generateObject\" scripts/extract-real-faqs.ts && echo \"PASS\"",
      "acceptanceCriteria": [
        "Function loadClassifications() exists",
        "Returns Map with topic IDs as keys",
        "Audit log shows topic counts",
        "No AI imports in file"
      ]
    },
    {
      "id": "story-ml48ufoe",
      "title": "Query DuckDB for real Q&A pairs by conversation ID",
      "description": "Add function to query DuckDB for actual message content:\n\n```typescript\nasync function getConversationQA(db: Connection, conversationId: string): Promise<{\n  question: string  // First inbound message body_text\n  answer: string    // Last outbound message body_text  \n  threadLength: number\n} | null>\n```\n\nSQL must select from `messages` table WHERE `conversation_id = ?`\n- Question = first message where is_inbound = true, ordered by created_at ASC\n- Answer = last message where is_inbound = false, ordered by created_at DESC\n\n⛔ FORBIDDEN: No text transformation, cleaning, or summarization\n✅ REQUIRED: Return EXACT body_text from database\n\nLog to audit: Sample of 3 extracted Q&A pairs showing raw text",
      "priority": 3,
      "passes": false,
      "validationCommand": "grep -q \"getConversationQA\" scripts/extract-real-faqs.ts && grep -q \"body_text\" scripts/extract-real-faqs.ts && grep -L \"generateText\" scripts/extract-real-faqs.ts && echo \"PASS\"",
      "acceptanceCriteria": [
        "Function getConversationQA exists",
        "Uses SQL SELECT from messages table",
        "Returns raw body_text without modification",
        "Audit shows sample extractions"
      ]
    },
    {
      "id": "story-ml48unht",
      "title": "Filter and rank conversations for quality extraction",
      "description": "Add function to filter conversations within each topic for extraction quality:\n\n```typescript\nfunction rankConversationsForExtraction(\n  conversationIds: string[], \n  db: Connection\n): Promise<string[]>  // Returns top 10 IDs\n```\n\nQuality signals (query from DuckDB):\n1. Thread length ≤ 4 messages (quick resolution)\n2. Has both inbound AND outbound messages\n3. Status = 'archived' (resolved)\n4. NOT tagged with 'spam' or 'collaboration'\n\nUse `packages/core/src/faq/filters.ts` shouldFilter() for additional spam detection on question text.\n\n⛔ FORBIDDEN: No LLM-based quality scoring\n✅ REQUIRED: Pure SQL + deterministic filters\n\nLog to audit: Filter stats per topic (total → after each filter → final)",
      "priority": 4,
      "passes": false,
      "validationCommand": "grep -q \"rankConversationsForExtraction\" scripts/extract-real-faqs.ts && grep -q \"shouldFilter\" scripts/extract-real-faqs.ts && echo \"PASS\"",
      "acceptanceCriteria": [
        "Function rankConversationsForExtraction exists",
        "Filters by thread length, status, tags",
        "Uses shouldFilter from filters.ts",
        "Returns max 10 per topic",
        "Audit shows filter funnel stats"
      ]
    },
    {
      "id": "story-ml48uv8l",
      "title": "Main extraction loop with JSONL output",
      "description": "Implement main() that:\n1. Loads classifications\n2. For each of 41 topics:\n   - Get conversation IDs for topic\n   - Rank/filter to top 10\n   - Extract real Q&A for each\n   - Write to output\n3. Output: `artifacts/phase-1/real-faq-candidates.jsonl`\n\nOutput schema per line:\n```json\n{\n  \"topicId\": \"email_change_request\",\n  \"topicName\": \"Email Change Request\", \n  \"conversationId\": \"cnv_xxx\",\n  \"question\": \"<EXACT body_text from first inbound message>\",\n  \"answer\": \"<EXACT body_text from last outbound message>\",\n  \"threadLength\": 3,\n  \"extractedAt\": \"2026-02-01T...\"\n}\n```\n\n⛔ FORBIDDEN: No summarization, no cleaning, no LLM enhancement of text\n✅ REQUIRED: question and answer are VERBATIM from messages.body_text\n\nLog to audit: Final stats - topics processed, total Q&A pairs extracted, any skipped topics",
      "priority": 5,
      "passes": false,
      "validationCommand": "bun scripts/extract-real-faqs.ts && test -f artifacts/phase-1/real-faq-candidates.jsonl && wc -l artifacts/phase-1/real-faq-candidates.jsonl | grep -E \"^[0-9]+\" && echo \"PASS\"",
      "acceptanceCriteria": [
        "Main function orchestrates full extraction",
        "Output file artifacts/phase-1/real-faq-candidates.jsonl created",
        "Each line is valid JSON with required fields",
        "Audit log shows completion stats"
      ]
    },
    {
      "id": "story-ml48v2jl",
      "title": "Validation: Verify extraction integrity (no LLM, data matches DB)",
      "description": "Create validation script `scripts/validate-faq-extraction.ts` that:\n\n1. **Code audit**: Grep extract-real-faqs.ts for forbidden patterns\n   - FAIL if contains: generateText, generateObject, import.*ai\n   \n2. **Data integrity**: Sample 5 random entries from output\n   - Query DuckDB for same conversation_id\n   - Verify question matches first inbound body_text EXACTLY\n   - Verify answer matches last outbound body_text EXACTLY\n   \n3. **Output validation**:\n   - All 41 topics represented (or documented why skipped)\n   - Each entry has non-empty question and answer\n   - No entries where question === answer\n\nWrite results to `artifacts/faq-extraction-validation.md`\n\n⛔ This is the guardrail story - it catches if earlier stories cheated",
      "priority": 6,
      "passes": false,
      "validationCommand": "bun scripts/validate-faq-extraction.ts && cat artifacts/faq-extraction-validation.md | grep -q \"PASS\" && echo \"PASS\"",
      "acceptanceCriteria": [
        "scripts/validate-faq-extraction.ts exists",
        "Checks for forbidden AI imports",
        "Verifies sample data matches DuckDB exactly",
        "Creates validation report",
        "Script exits 0 only if ALL checks pass"
      ]
    }
  ],
  "metadata": {
    "createdAt": "2026-02-01T21:18:54.627Z",
    "totalIterations": 2,
    "lastIteration": "2026-02-01T21:30:35.669Z"
  }
}