{
  "version": "1.0",
  "projectName": "cli-cleanup-tree-hygiene",
  "description": "Clean up CLI command sprawl: delete dead code, group commands into proper subcommand trees, deduplicate shared logic. This is prep work for the full CLI rearchitect (Epic #172). All changes in packages/cli/.",
  "stories": [
    {
      "id": "story-ml7gryfa",
      "title": "Delete dead CLI code",
      "description": "Delete all dead/unreachable CLI files that are never imported in packages/cli/src/index.ts. These files are confirmed dead — they have zero imports anywhere:\n\n1. `packages/cli/src/commands/front-stats.ts` (75 lines) — standalone script, never registered\n2. `packages/cli/src/commands/front-cache.ts` (1,277 lines) — never wired up, massive dead weight\n3. `packages/cli/src/alignment-test.ts` (64 lines) — standalone test script, never imported\n4. `packages/cli/src/test-agent-local.ts` (115 lines) — standalone test script, never imported\n5. `packages/cli/src/check-apps.ts` (16 lines) — standalone script, never imported\n6. `packages/cli/src/commands/eval-local/compare.ts` (171 lines) — hardcoded fake data placeholder, remove from eval-local/index.ts registration too\n\nAlso remove `@skillrecordings/sdk` from devDependencies in packages/cli/package.json — it has zero imports in the CLI package.\n\nAdd a changeset file (`.changeset/cli-cleanup-dead-code.md`) with:\n```\n---\n\"@skillrecordings/cli\": patch\n---\nchore: remove dead CLI code (front-cache, front-stats, alignment-test, test-agent-local, check-apps, eval-local compare stub)\n```\n\nTotal: approximately -1,718 lines of dead code removed.",
      "priority": 1,
      "passes": true,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "All 6 dead files deleted",
        "eval-local compare subcommand removed from registration",
        "@skillrecordings/sdk removed from devDependencies",
        "Changeset file created",
        "TypeScript compiles clean",
        "All existing tests pass"
      ]
    },
    {
      "id": "story-ml7gs6nw",
      "title": "Group Inngest commands under inngest subcommand",
      "description": "Currently Inngest commands are registered as 3 separate top-level calls in packages/cli/src/index.ts:\n- registerEventsCommands(program)\n- registerRunsCommands(program)\n- registerSignalCommand(program)\n\nPlus `investigate` is in a separate file but registered via events.\n\nConsolidate into a single `packages/cli/src/commands/inngest/index.ts` that:\n1. Creates an `inngest` subcommand group on the program\n2. Registers events, runs, signal, and investigate as subcommands under it\n3. Exports a single `registerInngestCommands(program)` function\n4. Update packages/cli/src/index.ts to use the single registration\n\nThe commands should work as: `skill inngest events`, `skill inngest runs`, `skill inngest signal`, `skill inngest investigate`\n\nKeep all existing functionality and flags unchanged. This is purely a structural reorganization.\n\nDo NOT create a changeset for this story — it will be included in the final cleanup changeset.",
      "priority": 2,
      "passes": true,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "Single registerInngestCommands(program) call in index.ts",
        "All inngest subcommands work under inngest parent",
        "Events, runs, signal, investigate all accessible",
        "No duplicate command registrations",
        "TypeScript compiles clean",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml7gsbmk",
      "title": "Group FAQ commands under faq subcommand",
      "description": "Currently FAQ commands are registered as 5 separate top-level calls in packages/cli/src/index.ts:\n- registerFaqMineCommands(program)\n- registerFaqClusterCommands(program)\n- registerFaqClassifyCommands(program)\n- registerFaqExtractCommands(program)\n- registerFaqReviewCommands(program)\n\nCreate a single `packages/cli/src/commands/faq/index.ts` that:\n1. Creates a `faq` subcommand group on the program\n2. Registers mine, cluster, classify, extract, review as subcommands under it\n3. Exports a single `registerFaqCommands(program)` function\n4. Move the individual faq-*.ts files into the `packages/cli/src/commands/faq/` directory (rename faq-mine.ts → faq/mine.ts, etc.)\n5. Update packages/cli/src/index.ts to use the single registration\n\nThe commands should work as: `skill faq mine`, `skill faq cluster`, `skill faq classify`, `skill faq extract`, `skill faq review`\n\nKeep all existing functionality and flags unchanged. Purely structural reorganization.\n\nDo NOT create a changeset — will be included in the final changeset.",
      "priority": 3,
      "passes": true,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "Single registerFaqCommands(program) call in index.ts",
        "All FAQ subcommands work under faq parent",
        "Individual faq-*.ts files moved to faq/ directory",
        "No duplicate command registrations",
        "TypeScript compiles clean",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml7gsi9z",
      "title": "Deduplicate eval seed logic",
      "description": "Two near-identical seed files exist:\n- `packages/cli/src/commands/eval-local/seed.ts` (276 lines)\n- `packages/cli/src/commands/eval-pipeline/seed.ts` (395 lines)\n\nThey share functions like: cleanDatabase(), loadJsonFiles(), loadKnowledgeFiles(), seedApps(), seedKnowledgeBase(), generateUUID().\n\nExtract the shared logic into `packages/cli/src/lib/eval-seed.ts`:\n1. Use the eval-pipeline version as the base (it's more polished: env var support, batch upsert, title extraction)\n2. Extract common functions: cleanDatabase, loadJsonFiles, loadKnowledgeFiles, seedApps, seedKnowledgeBase, generateUUID\n3. Update both eval-local/seed.ts and eval-pipeline/seed.ts to import from the shared module\n4. Remove duplicated code from both files — they should only contain their command-specific logic\n\nDo NOT create a changeset — will be included in the final changeset.",
      "priority": 4,
      "passes": true,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "Shared eval-seed.ts created in src/lib/",
        "Both eval-local/seed.ts and eval-pipeline/seed.ts import from shared module",
        "No duplicated function definitions between the two seed files",
        "TypeScript compiles clean",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml7gsmn2",
      "title": "Deduplicate Axiom helpers",
      "description": "Axiom helper functions are duplicated between:\n- `packages/cli/src/commands/axiom/index.ts` (697 lines)\n- `packages/cli/src/commands/axiom/forensic.ts` (868 lines)\n\nShared functions include: getAxiomClient(), getDataset(), parseTimeRange(), formatDuration(), formatTime(), and other utility functions.\n\nExtract shared helpers into `packages/cli/src/lib/axiom-client.ts`:\n1. Move getAxiomClient(), getDataset(), parseTimeRange(), formatDuration(), formatTime() to the shared module\n2. Update both axiom/index.ts and axiom/forensic.ts to import from the shared module\n3. Remove duplicated definitions\n\nDo NOT create a changeset — will be included in the final changeset.",
      "priority": 5,
      "passes": true,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "Shared axiom-client.ts created in src/lib/",
        "Both axiom/index.ts and axiom/forensic.ts import from shared module",
        "No duplicated helper functions between the two axiom files",
        "TypeScript compiles clean",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml7gssmt",
      "title": "Remove dead auth commands and crypto infrastructure",
      "description": "The age-based encryption auth commands are being replaced by 1Password native integration. Remove the dead infrastructure:\n\n1. Delete `packages/cli/src/commands/auth/keygen.ts` (41 lines) — age key generation, no longer needed\n2. Delete `packages/cli/src/commands/auth/encrypt.ts` (81 lines) — age encryption, no longer needed\n3. Delete `packages/cli/src/commands/auth/decrypt.ts` (123 lines) — age decryption, no longer needed\n4. Delete `packages/cli/src/lib/crypto.ts` (56 lines) — age encryption wrapper, no longer needed\n5. Update `packages/cli/src/commands/auth/index.ts` to remove keygen, encrypt, decrypt registrations\n6. Keep `auth status` command (still useful)\n7. Remove `age-encryption` from dependencies in packages/cli/package.json if no other file imports it (check first!)\n\nDo NOT create a changeset — will be included in the final changeset.",
      "priority": 6,
      "passes": true,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "keygen.ts, encrypt.ts, decrypt.ts deleted",
        "crypto.ts deleted",
        "auth/index.ts only registers status command",
        "age-encryption removed from dependencies if unused elsewhere",
        "TypeScript compiles clean",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml7gt5ex",
      "title": "Final cleanup: slim index.ts and add changeset",
      "description": "Final cleanup pass on packages/cli/src/index.ts after all previous stories have landed:\n\n1. Review index.ts and ensure all command registrations are clean and grouped logically\n2. Remove any stale imports that reference deleted files\n3. Ensure the command tree is organized into clear groups:\n   - Core: init, wizard, health, db-status\n   - Front: front (with subcommands)\n   - Inngest: inngest (with subcommands) \n   - Axiom: axiom (with subcommands)\n   - Eval: eval, eval-local, eval-pipeline, eval-prompt, pipeline\n   - Data: dataset, responses, tools, memory\n   - FAQ: faq (with subcommands)\n   - Infra: deploys, kb, auth\n4. Add comments grouping the registrations logically\n5. Create the final changeset file `.changeset/cli-cleanup-command-hygiene.md`:\n```\n---\n\"@skillrecordings/cli\": minor\n---\nrefactor: CLI command tree hygiene\n\n- Delete ~1,800 lines of dead code (front-cache, front-stats, alignment-test, test-agent-local, check-apps, eval-local compare stub)\n- Group Inngest commands under `inngest` subcommand\n- Group FAQ commands under `faq` subcommand\n- Deduplicate eval seed logic into shared module\n- Deduplicate Axiom helpers into shared module\n- Remove dead auth commands (keygen, encrypt, decrypt) and age crypto\n- Clean up index.ts with logical command grouping\n```\n\nNote: if Story 1 already created a changeset, remove it and replace with this comprehensive one.",
      "priority": 7,
      "passes": true,
      "validationCommand": "cd packages/cli && bun run check-types && bun run test",
      "acceptanceCriteria": [
        "index.ts has clean grouped registrations",
        "No stale imports remain",
        "Changeset file exists with minor bump",
        "Previous partial changeset removed if present",
        "TypeScript compiles clean",
        "All tests pass"
      ]
    },
    {
      "id": "story-ml6qgu1x",
      "title": "Bug Fix: Silent silence + collaborator allowlist (#146)",
      "description": "Fix agent commenting on silenced conversations. When route action is `silence` or category is `system`, NO comment should be posted to Front.\n\n## Implementation\n1. Find where comments are posted for silence/system decisions\n2. Add conditional to skip comment posting when action is silence\n3. Add `collaboratorEmails` config array that bypasses classification entirely\n4. Suggested collaborators: `alex@indyhall.org`\n\n## Acceptance Criteria\n- When route action is `silence` or category is `system`, NO comment is posted to Front\n- Conversation is still tagged appropriately\n- Escalation and draft comments still work normally\n- Add collaborator email allowlist in config that skips processing entirely\n\n## Files Likely Involved\n- `packages/core/src/pipeline/steps/route.ts`\n- `packages/inngest/src/functions/route-message.ts`\n- Comment posting logic\n\nGitHub Issue: https://github.com/skillrecordings/support/issues/146",
      "priority": 1,
      "passes": false,
      "validationCommand": "bun run check-types && bun run test"
    },
    {
      "id": "story-ml6qgu23",
      "title": "Bug Fix: Detect human response before drafting (#147)",
      "description": "Agent drafted even when team already responded. Before drafting, check if a team member has already responded to the customer's latest message.\n\n## Implementation\n1. In gather or pre-draft step, fetch conversation messages from Front\n2. Find the last inbound (customer) message timestamp\n3. Check if any outbound message from a teammate (not bot API user) exists after that timestamp\n4. If yes, skip draft step and log reason\n\n## Acceptance Criteria\n- Agent does NOT draft if team member responded after customer's last inbound message\n- Agent DOES draft if customer sends a NEW message after team response\n- Skip reason is logged to Axiom (e.g., `skip_reason: \"human_responded\"`)\n- Works for any team member, not just specific emails\n\n## Files Likely Involved\n- `packages/core/src/pipeline/steps/gather.ts` or `draft.ts`\n- `packages/inngest/src/functions/` — draft triggering logic\n\nGitHub Issue: https://github.com/skillrecordings/support/issues/147",
      "priority": 2,
      "passes": false,
      "validationCommand": "bun run check-types && bun run test"
    }
  ],
  "metadata": {
    "createdAt": "2026-02-04T03:24:28.522Z",
    "totalIterations": 7,
    "lastIteration": "2026-02-04T03:40:40.751Z"
  }
}