{
  "version": "1.0",
  "projectName": "epic3-validator-overhaul",
  "description": "Epic 3: Validator Overhaul â€” Ground truth comparison, fabrication detection, four-tier response system",
  "stories": [
    {
      "id": "story-ml61xjvm",
      "title": "Epic 3.1: Ground Truth + Relevance Fix (#138)",
      "description": "Wire skill retrieval into validator for ground truth comparison. Fix the broken LLM relevance check.\n\n## Files to modify\n- packages/core/src/pipeline/steps/validate.ts (main changes)\n- packages/core/src/pipeline/types.ts (if needed)\n\n## Implementation\n\n### 1. Import skill retrieval\n```typescript\nimport { retrieveSkills } from \"../../../scripts/skill-retrieval\";\n```\n\n### 2. In validate(), after pattern checks:\n```typescript\n// Retrieve relevant skills for ground truth\nconst customerMessage = input.originalMessage || input.draft.content;\nconst relevantSkills = await retrieveSkills(customerMessage, { topK: 3 });\n```\n\n### 3. Fix relevance check\n- Find why body assertion fails (look for relevanceCheck function)\n- Ensure customer message is passed correctly\n- Return numeric score 0.0-1.0\n\n### 4. Add ground truth comparison\n- Compare draft claims against skill content\n- Flag mismatches as validation issues\n\n## Tests to write FIRST (TDD)\nCreate in packages/core/src/pipeline/steps/__tests__/validate.test.ts:\n\n```typescript\ndescribe(\"ground truth comparison\", () => {\n  it(\"retrieves skills for customer message\", async () => {\n    // Mock retrieveSkills, verify called with message\n  });\n\n  it(\"passes when draft matches skill content\", async () => {\n    // Draft says \"30-day refund\" and skill confirms it\n  });\n\n  it(\"flags when draft contradicts skill content\", async () => {\n    // Draft says \"30-day refund\" but skill says \"60-day\"\n  });\n});\n\ndescribe(\"relevance check\", () => {\n  it(\"returns numeric score not N/A\", async () => {\n    // Verify relevance score is number between 0-1\n  });\n});\n```\n\n## Environment\nUpstash credentials needed - set before running:\n```bash\nexport UPSTASH_VECTOR_REST_URL=$(secrets lease upstash_vector_url --raw --ttl 2h --client-id \"ralph\")\nexport UPSTASH_VECTOR_REST_TOKEN=$(secrets lease upstash_vector_token --raw --ttl 2h --client-id \"ralph\")\nexport UPSTASH_REDIS_REST_URL=$(secrets lease upstash_redis_url --raw --ttl 2h --client-id \"ralph\")\nexport UPSTASH_REDIS_REST_TOKEN=$(secrets lease upstash_redis_token --raw --ttl 2h --client-id \"ralph\")\n```",
      "priority": 1,
      "passes": false,
      "validationCommand": "cd ~/Code/skillrecordings/support && bun test packages/core/src/pipeline/steps/__tests__/validate.test.ts 2>&1 | tail -20 && bun run check-types 2>&1 | tail -10",
      "acceptanceCriteria": [
        "retrieveSkills() called in validate step with customer message",
        "Relevance check returns numeric score (not N/A)",
        "Draft matching skill content passes validation",
        "Draft contradicting skill content flagged as issue",
        "All TypeScript type checks pass",
        "Tests written BEFORE implementation (TDD)"
      ]
    },
    {
      "id": "story-ml61xw85",
      "title": "Epic 3.2: Fabrication Detection (#139)",
      "description": "Detect when drafts make specific claims without source data from skills.\n\n## Files to modify\n- packages/core/src/pipeline/steps/validate.ts\n- packages/core/src/pipeline/types.ts (add fabrication issue type)\n\n## Implementation\n\n### 1. Define claim patterns\n```typescript\nconst FABRICATION_PATTERNS = {\n  price: /\\$[\\d,]+(?:\\.\\d{2})?/g,\n  timeline: /within \\d+ (?:hours?|days?|weeks?)/gi,\n  percentage: /\\d+%/g,\n  guarantee: /guarantee|always|never|definitely|certainly/gi,\n};\n```\n\n### 2. Extract claims from draft\n```typescript\nfunction extractClaims(draft: string): Claim[] {\n  const claims: Claim[] = [];\n  for (const [type, pattern] of Object.entries(FABRICATION_PATTERNS)) {\n    const matches = draft.matchAll(pattern);\n    for (const match of matches) {\n      claims.push({ type, value: match[0], index: match.index });\n    }\n  }\n  return claims;\n}\n```\n\n### 3. Cross-reference against skills\n```typescript\nfunction checkClaimAgainstSkills(claim: Claim, skills: RetrievedSkill[]): boolean {\n  // Check if claim appears in any skill content\n  for (const skill of skills) {\n    if (skill.description.includes(claim.value) || skill.markdown?.includes(claim.value)) {\n      return true; // Claim is sourced\n    }\n  }\n  return false; // Potential fabrication\n}\n```\n\n### 4. Add to validation issues\n```typescript\n// New issue type in types.ts\ntype ValidationIssueType = ... | 'fabrication';\n\n// Flag unsourced claims\nif (!isSourced) {\n  issues.push({\n    type: 'fabrication',\n    severity: claim.type === 'price' ? 'error' : 'warning',\n    message: `Unsourced ${claim.type} claim: ${claim.value}`,\n  });\n}\n```\n\n## Tests to write FIRST (TDD)\n```typescript\ndescribe(\"fabrication detection\", () => {\n  it(\"passes when price matches skill content\", async () => {\n    // Draft says \"$99\" and skill has \"$99\"\n  });\n\n  it(\"flags price claim not in skills\", async () => {\n    // Draft says \"$149\" but no skill mentions this\n  });\n\n  it(\"flags timeline without source\", async () => {\n    // Draft says \"within 24 hours\" with no source\n  });\n\n  it(\"does not flag quoted customer text\", async () => {\n    // Customer said \"$50\" - draft quoting them is fine\n  });\n});\n```\n\n## Depends on\nStory 1 (Ground Truth) must pass first - provides skill retrieval.",
      "priority": 2,
      "passes": false,
      "validationCommand": "cd ~/Code/skillrecordings/support && bun test packages/core/src/pipeline/steps/__tests__/validate.test.ts 2>&1 | tail -20 && bun run check-types 2>&1 | tail -10",
      "acceptanceCriteria": [
        "Price claims without skill source flagged as error",
        "Timeline claims without source flagged as warning",
        "Claims matching skill content pass validation",
        "No false positives on quoted customer text",
        "fabrication issue type added to types.ts",
        "Tests written BEFORE implementation (TDD)"
      ]
    },
    {
      "id": "story-ml61yb0c",
      "title": "Epic 3.3: Four-Tier Response System (#140)",
      "description": "Implement four-tier response system with category-specific thresholds.\n\n## Files to modify\n- packages/core/src/pipeline/steps/validate.ts\n- packages/core/src/pipeline/types.ts\n- NEW: packages/core/src/pipeline/thresholds.ts\n\n## Implementation\n\n### 1. New ValidatorDecision type (types.ts)\n```typescript\nexport type ValidatorDecision =\n  | { action: \"auto-send\"; draft: string; confidence: number }\n  | { action: \"draft\"; draft: string; issues?: ValidationIssue[] }\n  | { action: \"escalate\"; reason: string; urgency: \"normal\" | \"high\" | \"critical\" }\n  | { action: \"needs-review\"; draft: string; concerns: string[] };\n```\n\n### 2. Category thresholds (new file: thresholds.ts)\n```typescript\nexport interface CategoryThreshold {\n  autoSendMinConfidence: number;\n  autoSendMinVolume: number;\n  escalateAlways?: boolean;\n  escalateOnKeywords?: string[];\n}\n\nexport const CATEGORY_THRESHOLDS: Record<string, CategoryThreshold> = {\n  \"support_team-license\": {\n    autoSendMinConfidence: 0.98,\n    autoSendMinVolume: 50,\n    escalateAlways: true, // Nightmare #1: large team sales\n  },\n  \"support_bug-report\": {\n    autoSendMinConfidence: 0.95,\n    autoSendMinVolume: 30,\n    escalateOnKeywords: [\"multiple users\", \"widespread\", \"everyone\"],\n  },\n  \"support_refund\": {\n    autoSendMinConfidence: 0.95,\n    autoSendMinVolume: 100,\n  },\n  // Default for unspecified categories\n  default: {\n    autoSendMinConfidence: 0.95,\n    autoSendMinVolume: 50,\n  },\n};\n```\n\n### 3. Gradient scoring (validate.ts)\n```typescript\nfunction calculateConfidenceScore(issues: ValidationIssue[]): number {\n  let score = 1.0;\n  for (const issue of issues) {\n    switch (issue.severity) {\n      case 'error': score -= 0.3; break;\n      case 'warning': score -= 0.1; break;\n      case 'info': score -= 0.02; break;\n    }\n  }\n  return Math.max(0, score);\n}\n```\n\n### 4. Update validate() return\n```typescript\nexport async function validate(input: ValidateInput): Promise<ValidatorDecision> {\n  // ... existing checks ...\n\n  const confidence = calculateConfidenceScore(allIssues);\n  const threshold = CATEGORY_THRESHOLDS[category] || CATEGORY_THRESHOLDS.default;\n\n  // Check for escalation triggers\n  if (threshold.escalateAlways) {\n    return { action: \"escalate\", reason: \"Category requires human review\", urgency: \"normal\" };\n  }\n\n  // Check for auto-send eligibility (earned through RL)\n  const categoryStats = await getCategoryStats(category);\n  if (categoryStats.sentUnchangedRate >= threshold.autoSendMinConfidence \n      && categoryStats.volume >= threshold.autoSendMinVolume\n      && confidence >= 0.95) {\n    return { action: \"auto-send\", draft: input.draft.content, confidence };\n  }\n\n  // Default to draft\n  return { action: \"draft\", draft: input.draft.content, issues: allIssues };\n}\n```\n\n## Tests to write FIRST (TDD)\n```typescript\ndescribe(\"four-tier response system\", () => {\n  it(\"returns draft action by default\", async () => {});\n  it(\"escalates team-license category always\", async () => {});\n  it(\"calculates gradient score correctly\", async () => {});\n  it(\"auto-send only when category has earned it\", async () => {});\n});\n\ndescribe(\"category thresholds\", () => {\n  it(\"uses category-specific threshold when defined\", async () => {});\n  it(\"falls back to default threshold\", async () => {});\n});\n```",
      "priority": 3,
      "passes": false,
      "validationCommand": "cd ~/Code/skillrecordings/support && bun test packages/core/src/pipeline/steps/__tests__/validate.test.ts 2>&1 | tail -20 && bun test packages/core/src/pipeline/__tests__/thresholds.test.ts 2>&1 | tail -10 && bun run check-types 2>&1 | tail -10",
      "acceptanceCriteria": [
        "ValidatorDecision type with 4 actions implemented",
        "Default action is 'draft'",
        "Team license category triggers escalate",
        "Gradient scoring calculates 0.0-1.0",
        "Category thresholds file created",
        "Auto-send only for earned categories",
        "Tests written BEFORE implementation (TDD)"
      ]
    }
  ],
  "metadata": {
    "createdAt": "2026-02-03T03:41:05.745Z",
    "totalIterations": 0
  }
}